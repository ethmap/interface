<template>
  <div>
    <!-- Loader -->
    <loader v-if="!mapLoaded" />
    <!-- Wrong network -->
    <div class="ui container">
      <div v-if="networkUnknown" class="ui segment center aligned raised"
           style="margin-top: 1em;">
        Select <b>Main Network</b> in MetaMask
      </div>
    </div>
    <!-- Map -->
    <div id="map"></div>
  </div>
</template>

<script>
import Loader from '@/components/Loader'

import Datamap from 'datamaps'
import d3 from 'd3'
import Zone from '@/api/Zone'

export default {
  name: 'main',
  components: {
    Loader
  },
  data () {
    return {
      selectedZone: null,
      zonesListID: []
    }
  },
  watch: {
    zones (zones) {
      if (zones.length === 178) {
        this.getZonesListId()
      }
    },
    zonesListID (zones) {
      if (zones.length === 178) {
        this.createMap()
      }
    }
  },
  computed: {
    contract () {
      return this.$store.getters.contract
    },
    zones () {
      return this.$store.getters.zones
    },
    zonesBought () {
      return this.zones.filter(z => z.isBought())
    },
    mapLoaded () {
      return this.$store.getters.mapLoaded
    },
    networkUnknown () {
      return this.$store.getters.networkUnknown
    }
  },
  methods: {
    selectZone (zoneId) {
      const zone = Zone.getById(zoneId)
      this.selectedZone = zone
      this.$modal.show('zoneModal', {
        zone: zone
      })
    },
    fillColor () {
      let color = {}
      this.zonesListID.forEach((z, index) => {
        const zone = Zone.getById(index + 1)
        color[z] = { fillKey: zone.zoneKeyFill() }
      })
      return color
    },
    createMap () {
      let that = this
      let colors = that.fillColor()
      /* eslint-disable no-new */
      let map = new Datamap({
        element: document.getElementById('map'),
        scope: 'world',
        responsive: true,
        geographyConfig: {
          dataUrl: './static/data/world.topo.json',
          hideAntarctica: false,
          highlightFillColor: '#D3D3D3',
          highlightBorderColor: '#FFFFFF',
          popupTemplate (geography, data) {
            const zone = Zone.getById(geography.properties.id)
            const price = zone.getRequiredPrice()
            let hoverInfo = ''
            switch (zone.zoneKeyFill()) {
              case 'OWNER_MIGRATE': hoverInfo = `<i class="fa fa-tag"></i> You own this zone, but it must be migrated to be fully compatible with OpenSea`; break
              case 'MIGRATE': hoverInfo = `<i class="fa fa-tag"></i> Requires migration`; break
              case 'AVAILABLE': hoverInfo = `<i class="fa fa-tag"></i> Price: ${price} Ξ`; break
              case 'NOT_AVAILABLE': hoverInfo = `<i class="fa fa-times"></i> Not for sale`; break
              case 'OWNER_SALE': hoverInfo = `<i class="fa fa-money"></i> On sale for ${price} Ξ`; break
              case 'OWNER': hoverInfo = `<i class="fa fa-user"></i> You own this zone, but it must be wrapped to be compatible with OpenSea`; break
              case 'OWNER_WRAPPED': hoverInfo = `<i class="fa fa-user"></i> You own this zone`; break
              case 'PENDING_OWNER': hoverInfo = `<i class="fa fa-user"></i> You are wrapping this zone`; break
              case 'OPENSEA': hoverInfo = `<i class="fa fa-user"></i> Listed on OpenSea`; break
            }
            return `<div class="hoverinfo"><b><span class="flag flag-${zone.code.toLowerCase()}"></span>
                                              ${geography.properties.name}</b><br />
                                              ${hoverInfo}<br /></div>`
          }
        },
        fills: {
          defaultFill: '#D3D3D3',
          'AVAILABLE': '#A8DADC',
          'NOT_AVAILABLE': 'rgba(230, 57, 70, 0.5)',
          'OWNER': 'url(#owner_wrap_needed)',
          'OWNER_WRAPPED': '#FCDE9C',
          'OWNER_SALE': 'rgba(255, 136, 17, 0.5)',
          'PENDING_OWNER': 'rgba(3, 244, 252, 0.5)',
          'OPENSEA': 'rgba(24, 104, 183, 0.5)',
          'MIGRATE': 'rgba(233, 145, 255, 0.5)',
          'OWNER_MIGRATE': 'url(#owner_migrate_needed)'

        },
        data: colors,
        setProjection (element) {
          let projection = d3.geo.equirectangular()
            .scale((element.offsetWidth / 640) * 100)
            .translate([element.offsetWidth / 2, element.offsetHeight / 2 - 50])

          var path = d3.geo.path().projection(projection)
          return { path: path, projection: projection }
        },
        done (datamap) {
          let mapNode = document.querySelector('.datamap')
          let patternContainer = document.querySelector('#patterns')
          let patternDefs = patternContainer.firstChild.cloneNode(true)
          mapNode.prepend(patternDefs)
          patternContainer.removeChild(patternContainer.firstChild)

          that.$store.dispatch('setMapLoaded', true)
          datamap.svg.call(d3.behavior.zoom().on('zoom', redraw))
          function redraw () {
            // Scale
            datamap.svg.selectAll('g')
              .attr('transform', 'translate(' + d3.event.translate + ')scale(' + d3.event.scale + ')')
          }
          datamap.svg.selectAll('.datamaps-subunit')
            .on('click', (geography) => {
              that.selectZone(geography.properties.id)
            })
        }
      })
      d3.select(window).on('resize', () => {
        map.resize()
      })
      setInterval(() => {
        map.updateChoropleth(this.fillColor())
      }, 5000)
    },
    getZonesListId () {
      let world = require('../../static/data/world.topo.json')
      let zones = world.objects.world.geometries
      this.zonesListID = zones.map((c) => {
        let zone = Zone.getById(c.properties.id)
        zone.code = c.id
        zone.name = c.properties.name
        return c.id
      })
    }
  },
  mounted () {
  }
}
</script>

<style scoped>
#map {
  background-color: #FFF;
  width: 100%;
  height: 100%;
}

.hoverinfo {
  position: absolute;
  text-align: center;
  width: 150px;
  height: 25px;
  padding: 2px;
  font-size: 10px;
  background: #FFFFE0;
  color: rgba(255, 136, 17, 0.75) !important;
  border: 1px;
  border-radius: 8px;
  pointer-events: none;
} 
</style>
